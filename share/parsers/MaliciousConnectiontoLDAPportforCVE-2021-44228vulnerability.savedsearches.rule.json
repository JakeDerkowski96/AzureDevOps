{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "properties": {
                "category": "Hunting Queries",
                "displayName": "Malicious Connection to LDAP port for CVE-2021-44228 vulnerability",
                "query": "let PrivateIPregex = @'^127\\.|^10\\.|^172\\.1[6-9]\\.|^172\\.2[0-9]\\.|^172\\.3[0-1]\\.|^192\\.168\\.';\nlet Port = dynamic(['389', '1389']); \n(union isfuzzy=true\n(DeviceNetworkEvents\n| where InitiatingProcessFileName has_any (\"javaw.exe\",\"java.exe\")\n| where ActionType has \"ConnectionSuccess\"\n| where RemotePort in ('389', '1389')\n| where InitiatingProcessCommandLine has_any ('curl', 'wget')\n| where RemoteIPType =~ 'Public'\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by ActionType, DestinationIP = RemoteIP, RemoteUrl, DestinationPort = RemotePort, SourceIP = LocalIP, Type, InitiatingProcessAccountName, InitiatingProcessCommandLine, InitiatingProcessFolderPath,  InitiatingProcessParentFileName, ProcessName = InitiatingProcessFileName, Computer = DeviceName\n| extend timestamp = StartTime, IPCustomEntity = DestinationIP, HostCustomEntity = Computer\n),\n(VMConnection\n| where ProcessName has_any (\"javaw\",\"java\")\n| where DestinationPort in ('389', '1389')\n| extend DestinationIpType = iff(DestinationIp matches regex PrivateIPregex,\"private\" ,\"public\" )\n| where DestinationIpType == \"public\"\n| summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated) by TimeGenerated, SourceIP = SourceIp , DestinationIP = DestinationIp, DestinationPort,  BytesReceived, BytesSent, ProcessName, Computer\n| extend timestamp = StartTime, IPCustomEntity = DestinationIP, HostCustomEntity = Computer\n)\n)\n",
                "tags": [
                    {
                        "name": "description",
                        "value": "This hunting query looks for connection to the default LDAP ports to find possible exploitation attempts for CVE-2021-44228 involving log4j vulnerability."
                    },
                    {
                        "name": "tactics",
                        "value": "CommandAndControl"
                    }
                ],
                "version": 2
            },
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/apache log4j vulnerability detection hunting query 2')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/savedSearches",
            "apiVersion": "2020-08-01"
        }
    ]
}
